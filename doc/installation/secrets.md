# Secrets

GitLab requires a variety of secrets to operate:

Gitlab Components:
* Registry authentication certificates
* SSH Host Keys and Certificates for GitLab Shell
* Passwords for individual Gitlab services

Optional External Services
* SMTP server
* Omniauth
* IMAP for incoming emails (via mail_room service)


Any secret not provided manually will be automatically generated with a random value. Automatic generation of HTTPS certificates is provided by Let's Encrypt.

To utilize autogenerated secrets continue to [next steps](#next-steps).

To specify your own secrets, proceed to [manual secret creation](#manual-secret-creation).

## Manual secret creation (optional)

- [TLS certificates](tls.md)
- [Registry authentication certificates](#registry-authentication-certificates)
- [SSH Host Keys](#ssh-host-keys)
- [Passwords](#passwords)
  * [Redis password](#redis-password)
  * [Postgres password](#postgres-password)
  * [Registry HTTP Secret](#registry-http-secret)
  * [GitLab Shell Secret](#gitlab-shell-secret)
  * [Gitaly Secret](#gitaly-secret)
  * [Minio Secret](#minio-secret)
- [External Services](#external-services)
  * [Unicorn Omniauth](#unicorn-omniauth)
  * [SMTP Password](#smtp-password)
  * [IMAP Password](#imap-password-for-incoming-emails)

### Registry authentication certificates

Communication between GitLab and Registry happens behind an Ingress so it is sufficient in most cases to use self-signed certificates
for this communication. If this traffic is exposed over a network, you
should generate publicly valid certificates.

In the example below, we assume that we require self-signed certificates.

Generate a certificate-key pair:

```
mkdir -p certs
openssl req -new -newkey rsa:4096 -subj "/CN=gitlab-issuer" -nodes -x509 -keyout certs/registry-example-com.key -out certs/registry-example-com.crt
```

Create a secret containing these certificates.
 We will create `registry-auth.key` and `registry-auth.crt` keys inside the
`gitlab-registry` secret.

```
kubectl create secret generic gitlab-registry --from-file=registry-auth.key=certs/registry-example-com.key --from-file=registry-auth.crt=certs/registry-example-com.crt
```

Include this secret using `--set global.registry.certificate.secret=gitlab-registry`

### SSH Host Keys

Generate the OpenSSH certificate-key pairs:

```
mkdir -p hostKeys
ssh-keygen -t rsa  -f hostKeys/ssh_host_rsa_key -N ""
ssh-keygen -t dsa  -f hostKeys/ssh_host_dsa_key -N ""
ssh-keygen -t ecdsa  -f hostKeys/ssh_host_ecdsa_key -N ""
ssh-keygen -t ed25519  -f hostKeys/ssh_host_ed25519_key -N ""
```

Create the secret containing these certificates.

```
kubectl create secret generic gitlab-shell-host-keys --from-file hostKeys
```

Include this secret using `--set global.shell.hostKeys.secret=gitlab-shell-host-keys`

### Initial root password

Create a kubernetes secret for storing the initial root password. The password
should be at least 6 characters long. In the following command, replace
`<your password>` with the value.

```
kubectl create secret generic gitlab-gitlab-initial-root-password --from-literal=password=<your password>
```

### Redis password

Generate a random 64 character alpha-numeric password for Redis.

```
kubectl create secret generic gitlab-redis --from-literal=redis-password=$(head -c 512 /dev/urandom | LC_CTYPE=C tr -cd 'a-zA-Z0-9' | head -c 64)
```

### GitLab Shell secret

Generate a random 64 character alpha-numeric secret for GitLab Shell.

```
kubectl create secret generic gitlab-shell-secret --from-literal=secret=$(head -c 512 /dev/urandom | LC_CTYPE=C tr -cd 'a-zA-Z0-9' | head -c 64)
```

Include this secret using `--set global.shell.authToken.secret=gitlab-shell-secret`

### Gitaly secret

Generate a random 64 character alpha-numeric token for Gitaly.

```
kubectl create secret generic gitaly-secret --from-literal=token=$(head -c 512 /dev/urandom | LC_CTYPE=C tr -cd 'a-zA-Z0-9' | head -c 64)
```

Include this secret using `--set global.gitaly.authToken.secret=gitaly-secret`

### Minio secret

Generate a set of random 20 & 64 character alpha-numeric keys for Minio.

```
kubectl create secret generic gitlab-minio --from-literal=accesskey=$(head -c 512 /dev/urandom | LC_CTYPE=C tr -cd 'a-zA-Z0-9' | head -c 20) --from-literal=secretkey=$(head -c 512 /dev/urandom | LC_CTYPE=C tr -cd 'a-zA-Z0-9' | head -c 64)
```
Include this secret using `--set global.minio.credentials.secret=minio-secret`

### Postgresql secret

Generate a set of random 20 & 64 character alpha-numeric keys for database password.

```
kubectl create secret generic gitlab-postgresql-password --from-literal=postgres-password=$(head -c 512 /dev/urandom | LC_CTYPE=C tr -cd 'a-zA-Z0-9' | head -c 64)
```

### Registry HTTP Secret

Generate a random 64 character alpha-numeric key key shared by all registry pods.

```
kubectl create secret generic gitlab-registry-httpsecret --from-literal=secret=$(head -c 512 /dev/urandom | LC_CTYPE=C tr -cd 'a-zA-Z0-9' | head -c 64 | base64 )
```

## External services

Some charts have further secrets to enable functionality that can not be automatically generated.

### Unicorn Omniauth

In order to enable the use of [Omniauth Providers](https://docs.gitlab.com/ee/integration/omniauth.html) with the deployed GitLab, please follow the [instructions in the Unicorn chart](../charts/gitlab/unicorn/README.md#omniauth.providers)

### SMTP password

If you are using an SMTP server that requires authentication, store the password
in a Kubernetes secret.

```
kubectl create secret generic smtp-password --from-literal=password=yourpasswordhere
```

Then use `--set global.smtp.password.secret=smtp-password` in your helm command.

### IMAP password for incoming emails

To let GitLab have access to [incoming emails](https://docs.gitlab.com/ee/administration/incoming_email.html)
store the password of the IMAP account in a Kubernetes secret.

```
kubectl create secret generic incoming-email-password --from-literal=password=yourpasswordhere
```

Then use `--set global.appConfig.incomingEmail.password.secret=incoming-email-password`
in your helm command along with other required settings as specified [in the docs](command-line-options.md#incoming-email-configuration).

## Next steps

Once all secrets have been generated and stored, you can proceed [deploying GitLab](deployment.md).
